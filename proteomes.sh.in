#!/bin/bash

# Arguments:
# - The gzipped proteomes file.
# - The output file.
proteome_gz_file="$1"
type_strains="$2"
outfile="$3"

set -o pipefail -e

tmp="$(<<<CMD_MKTEMP>>> proteomes.XXXXXXX)"

get_proteome() {
    local id="$1"
    local accession="$2"
    local table="$(curl -s http://www.uniprot.org/proteomes/$accession \
                 | tr $'\n' ' ' | <<<CMD_SED>>> 's_<td[^>]*>_\n&_g' \
                 | grep '^<td' | <<<CMD_SED>>> 's_<[^>]*>__g' \
                 | tr -s '[:blank:]' ' ' | <<<CMD_SED>>> -n 'N;s/\n/\t/;p;d' \
                 )"
    local name="$(grep '^Proteome name' <<<"$table" | <<<CMD_SED>>> 's/.*\t//')"
    local strain="$(grep '^Strain' <<<"$table" | <<<CMD_SED>>> 's/.*\t//')"
    local assembly="$(grep '^Genome assembly' <<<"$table" | head -1 | <<<CMD_SED>>> -e 's/.*\t *//' -e 's/ *from.*//')"
    printf '%s\t%s\t%s\t\\N\t\0\t%b\t%s\t%s\n' \
        "$id" \
        "$accession" \
        "${name% - Reference proteome}" \
        "$(grep -q 'Reference proteome' <<<"$name" && echo '\01' || echo '\00')" \
        "${strain:-\\N}" \
        "${assembly:-\\N}"
}
# to reach it with the bash subprocess of xargs
export -f get_proteome

<<<CMD_ZCAT>>> $proteome_gz_file \
    | xargs -P 10 -I{} bash -c 'get_proteome {}' > "$tmp"

<<<CMD_JOIN>>> -1 8 -2 1 -a 1 -t '	'                                               \
        <(<<<CMD_SORT>>> -t'	' -k 8 "$tmp")                                      \
        <(<<<CMD_SORT>>> "$type_strains" | <<<CMD_SED>>> 's/$/\t\x01/')             \
    | <<<CMD_SED>>> "/\x01$/!s/$/	\x00/"                                          \
    | <<<CMD_AWK>>> 'BEGIN { FS = OFS = "	" }{ print $2,$3,$4,$5,$9,$7,$8,$1 }'   \
    | <<<CMD_SORT>>> -n                                                             \
    | <<<CMD_GZIP>>>                                                                \
    > $outfile

rm "$tmp"
