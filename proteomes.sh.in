#!/bin/bash

# Arguments:
# - The gzipped proteomes file.
# - The output file.
proteome_gz_file="$1"
type_strains="$2"
outfile="$3"

set -o pipefail -e

tmp="$(<<<CMD_MKTEMP>>> proteomes.XXXXXXX)"

get_proteome() {
    local id="$1"
    local accession="$2"
    local table="$(curl -s http://www.uniprot.org/proteomes/$accession \
                 | tr $'\n' ' ' | <<<CMD_SED>>> 's_<td[^>]*>_\n&_g' \
                 | grep '^<td' | <<<CMD_SED>>> 's_<[^>]*>__g' \
                 | tr -s '[:blank:]' ' ' | <<<CMD_SED>>> -n 'N;s/\n/\t/;p;d' \
                 )"
    local name="$(grep '^Proteome name' <<<"$table" | <<<CMD_SED>>> 's/.*\t//')"
    local strain="$(grep '^Strain' <<<"$table" | <<<CMD_SED>>> 's/.*\t//')"
    local assembly="$(grep '^Genome assembly' <<<"$table" | head -1 | <<<CMD_SED>>> -e 's/.*\t *//' -e 's/ *from.*//')"
    printf '%s\t%s\t%s\t%b\t%s\t%s\n' \
        "$id" \
        "$accession" \
        "${name% - Reference proteome}" \
        "$(grep -q 'Reference proteome' <<<"$name" && echo '\01' || echo '\00')" \
        "${strain:-\\N}" \
        "${assembly:-\\N}"
}
# to reach it with the bash subprocess of xargs
export -f get_proteome

<<<CMD_ZCAT>>> $proteome_gz_file \
    | xargs -P 10 -I{} bash -c 'get_proteome {}' > "$tmp"

# tmp: id accession-id name-str reference-bool strain-id assembly-id
# strain: assembly-id

# join: assembly-id id accession-id name-str reference-bool strain-id strain-bool?
# sed:  1)assembly-id 2)id 3)accession-id 4)name-str 5)reference-bool 6)strain-id 7)strain-bool
# awk: id accession-id name-str TAXON strain-bool reference-bool strain-id assembly-id
<<<CMD_JOIN>>> -1 6 -2 1 -a 1 -t '	' \
        <(<<<CMD_SORT>>> -t'	' -k 6 "$tmp") \
        <(<<<CMD_SORT>>> "$type_strains" | <<<CMD_SED>>> 's/$/\t\x01/') \
    | <<<CMD_SED>>> "/\x01$/!s/$/	\x00/" \
    | <<<CMD_AWK>>> 'BEGIN { FS = OFS = "	" }{ print $2,$3,$4,"\\N",$7,$5,$6,$1,"\\N" }' \
    | <<<CMD_SORT>>> -n \
    | <<<CMD_GZIP>>> \
    > $outfile

rm "$tmp"
